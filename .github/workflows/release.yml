name: Release

on:
  push:
    tags:
      - v*

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python & uv
        uses: ./.github/actions/setup-python

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get Version
        id: version
        run: |
          echo "VERSION=$(uvx --from=toml-cli toml get --toml-path=pyproject.toml project.version)" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Check Version
        if: steps.version.outputs.VERSION != steps.version.outputs.TAG_VERSION
        run: |
          echo "Version mismatch: ${{ steps.version.outputs.VERSION }} != ${{ steps.version.outputs.TAG_VERSION }}"
          exit 1

      - name: Build Frontend
        env:
          VITE_BACKEND_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          cd frontend
          pnpm install
          pnpm build

      - name: Copy Static Files
        run: |
          mkdir -p AutoGLM_GUI/static
          cp -r frontend/dist/* AutoGLM_GUI/static/

      - name: Build Package
        run: uv build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Create Release if not exists
        run: |
          gh release view ${{ steps.version.outputs.TAG_NAME }} || \
          gh release create ${{ steps.version.outputs.TAG_NAME }} --title "${{ steps.version.outputs.TAG_NAME }}" --notes "Release ${{ steps.version.outputs.TAG_NAME }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Asset
        run: gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} dist/*.tar.gz dist/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: release
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from tag
        id: version
        run: |
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Generate summary
        run: |
          echo "## Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Build Electron application for macOS
  build-electron-macos:
    name: Build Electron (macOS ARM64)
    runs-on: macos-latest
    needs: release
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pre-clean mounted images
        run: |
          hdiutil info | awk '/\/dev\/disk[0-9]+/ {print $1}' | xargs -n1 -I{} hdiutil detach -force -quiet {} || true
          sleep 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'

      - name: Get pnpm store directory
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Build Electron application
        run: uv run python scripts/build_electron.py

      - name: Get version
        id: version
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Find and upload macOS artifacts
        run: |
          # Find DMG file
          dmg_file=$(find electron/dist -type f -name "*.dmg" ! -name "*.blockmap" | head -n 1)
          if [ -n "$dmg_file" ]; then
            echo "Uploading DMG: $(basename "$dmg_file")"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} "$dmg_file"
          fi

          # Find blockmap file
          blockmap_file=$(find electron/dist -type f -name "*.dmg.blockmap" | head -n 1)
          if [ -n "$blockmap_file" ]; then
            echo "Uploading blockmap: $(basename "$blockmap_file")"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} "$blockmap_file"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build Electron application for macOS (Intel x64)
  build-electron-macos-x64:
    name: Build Electron (macOS x64)
    runs-on: macos-15-intel  # macOS Intel runner
    needs: release
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Disable Spotlight indexing
        run: |
          # Disable Spotlight indexing to prevent hdiutil resource busy errors
          sudo mdutil -a -i off || true
          # Kill any mds processes that might be accessing disk images
          sudo pkill -9 mds || true
          sudo pkill -9 mds_stores || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'

      - name: Get pnpm store directory
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-x64-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-x64-pnpm-store-

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-x64-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-x64-uv-

      - name: Build Electron application
        run: uv run python scripts/build_electron.py

      - name: Get version
        id: version
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Find and upload macOS x64 artifacts
        run: |
          # Find DMG file
          dmg_file=$(find electron/dist -type f -name "*.dmg" ! -name "*.blockmap" | head -n 1)
          if [ -n "$dmg_file" ]; then
            echo "Uploading DMG: $(basename "$dmg_file")"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} "$dmg_file"
          fi

          # Find blockmap file
          blockmap_file=$(find electron/dist -type f -name "*.dmg.blockmap" | head -n 1)
          if [ -n "$blockmap_file" ]; then
            echo "Uploading blockmap: $(basename "$blockmap_file")"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} "$blockmap_file"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build Electron application for Windows
  build-electron-windows:
    name: Build Electron (Windows x64)
    runs-on: windows-latest
    needs: release
    permissions:
      contents: write

    env:
      PYTHONIOENCODING: utf-8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        shell: pwsh
        run: |
          irm https://astral.sh/uv/install.ps1 | iex
          echo "$env:USERPROFILE\.cargo\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'

      - name: Get pnpm store directory
        shell: pwsh
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $env:GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Build Electron application
        run: uv run python scripts/build_electron.py

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $tagName = $env:GITHUB_REF -replace '^refs/tags/', ''
          echo "TAG_NAME=$tagName" >> $env:GITHUB_OUTPUT

      - name: Find and upload Windows artifacts
        shell: pwsh
        run: |
          # Find portable exe (not containing "Setup")
          $portableExe = Get-ChildItem -Path electron\dist -Filter *.exe -File | Where-Object { $_.Name -notmatch "Setup" } | Select-Object -First 1
          if ($portableExe) {
            Write-Host "Uploading portable: $($portableExe.Name)"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} $portableExe.FullName
          }

          # Find setup exe (containing "Setup")
          $setupExe = Get-ChildItem -Path electron\dist -Filter *.exe -File | Where-Object { $_.Name -match "Setup" } | Select-Object -First 1
          if ($setupExe) {
            Write-Host "Uploading setup: $($setupExe.Name)"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} $setupExe.FullName
          }

          # Find blockmap
          $blockmap = Get-ChildItem -Path electron\dist -Filter *.exe.blockmap -File | Select-Object -First 1
          if ($blockmap) {
            Write-Host "Uploading blockmap: $($blockmap.Name)"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} $blockmap.FullName
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build Electron application for Linux
  build-electron-linux:
    name: Build Electron (Linux x64)
    runs-on: ubuntu-latest
    needs: release
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'

      - name: Get pnpm store directory
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Build Electron application
        run: uv run python scripts/build_electron.py

      - name: Get version
        id: version
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Find and upload Linux artifacts
        run: |
          # Find AppImage file
          appimage_file=$(find electron/dist -type f -name "*.AppImage" | head -n 1)
          if [ -n "$appimage_file" ]; then
            echo "Uploading AppImage: $(basename "$appimage_file")"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} "$appimage_file"
          fi

          # Find deb file
          deb_file=$(find electron/dist -type f -name "*.deb" | head -n 1)
          if [ -n "$deb_file" ]; then
            echo "Uploading deb: $(basename "$deb_file")"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} "$deb_file"
          fi

          # Find tar.gz file
          targz_file=$(find electron/dist -type f -name "*.tar.gz" | head -n 1)
          if [ -n "$targz_file" ]; then
            echo "Uploading tar.gz: $(basename "$targz_file")"
            gh release upload --clobber ${{ steps.version.outputs.TAG_NAME }} "$targz_file"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
